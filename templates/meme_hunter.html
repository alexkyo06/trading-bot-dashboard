<!-- templates/meme_hunter.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Meme å¸ç‹©çŒä»ªè¡¨ç›˜</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { max-width: 1200px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
        .feed-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--border-radius); }
        .feed-list li { border-bottom: 1px solid var(--border); padding: 0.75rem; }
        .feed-list li:last-child { border-bottom: none; }
        .signal { background-color: var(--accent-bg); border-left: 4px solid var(--accent); padding-left: 1rem; margin-bottom: 0.5rem; }
        .card h3 { margin-top: 0; }
        .token-info strong { font-size: 1.1em; }
        .token-details { font-size: 0.9em; color: var(--text-light); word-break: break-all; }
        .log-level-INFO { color: var(--text); }
        .log-level-ERROR { color: red; font-weight: bold; }
        .log-level-DEBUG { color: grey; }
    </style>
</head>
<body>
<div id="app">
    <header>
        <h1>ğŸ›¸ Meme å¸ç‹©çŒä»ªè¡¨ç›˜ V2</h1>
        <p>å®æ—¶ç›‘æ§æ–°å¸åŠ¨æ€ (æ•°æ®æº: Telegram)</p>
    </header>

    {% raw %} <!-- å¼€å§‹ Jinja2 çš„ raw å— -->
    <main>
        <div class="grid">
            <section class="card">
                <h3>ğŸ”¥ Alpha ä¿¡å·é›·è¾¾ (Strong Signals)</h3>
                <ul class="feed-list">
                    <li v-if="loading.signals">æ­£åœ¨åŠ è½½ä¿¡å·... <progress></progress></li>
                    <li v-if="!loading.signals && !signals.length && !error.signals">æš‚æ— å¼ºä¿¡å·...</li>
                    <li v-for="item in signals" :key="item.id || item.contract" class="signal">
                        <div class="token-info">
                            <strong>{{ item.token_name || 'æœªçŸ¥ä»£å¸' }} ({{ item.token_symbol || 'N/A' }})</strong>
                        </div>
                        <div class="token-details">
                            åˆçº¦: {{ item.contract ? item.contract.substring(0,6)+'...'+item.contract.substring(item.contract.length-4) : 'N/A' }} <br>
                            æ¥æº: {{ item.source_channel || 'N/A' }} | çƒ­åº¦: {{ item.social_mentions || 0 }}<br>
                            æ—¶é—´: {{ formatTime(item.timestamp) }} <br>
                            <template v-if="item.links && item.links.length">
                                é“¾æ¥: <a v-for="(link, idx) in item.links" :key="idx" :href="link" target="_blank" rel="noopener noreferrer">{{ getLinkDomain(link) }}</a>
                            </template>
                        </div>
                    </li>
                    <li v-if="error.signals" style="color: red;">æ— æ³•åŠ è½½ä¿¡å·: {{ error.signals }}</li>
                </ul>
            </section>
            <section class="card">
                <h3>ğŸ“œ æœºå™¨äººæ—¥å¿— (Bot Logs)</h3>
                <ul class="feed-list">
                    <li v-if="loading.logs">ç­‰å¾…æ—¥å¿—... <progress></progress></li>
                    <li v-if="!loading.logs && !logs.length && !error.logs">æš‚æ— æ—¥å¿—...</li>
                    <li v-for="log in logs" :key="log.id">
                        <small>{{ formatTime(log.timestamp) }} [<span :class="'log-level-' + log.level">{{ log.level }}</span>]</small><br>
                        {{ log.message }}
                    </li>
                    <li v-if="error.logs" style="color: red;">æ— æ³•åŠ è½½æ—¥å¿—: {{ error.logs }}</li>
                </ul>
            </section>
        </div>

        <section class="card" style="margin-top: 1.5rem;">
            <h3>ğŸ›°ï¸ æ–°å¸å®æ—¶æµ (Live Feed)</h3>
            <ul class="feed-list">
                <li v-if="loading.feed">æ­£åœ¨æ‰«ææ–°å¸... <progress></progress></li>
                <li v-if="!loading.feed && !feed.length && !error.feed">æš‚æ— æ–°å¸...</li>
                <li v-for="item in feed" :key="item.id || item.contract">
                    <div class="token-info">
                        <strong>{{ item.token_name || 'æ–°å¸' }} ({{ item.token_symbol || 'N/A' }})</strong>
                    </div>
                    <div class="token-details">
                        åˆçº¦: {{ item.contract ? item.contract.substring(0,6)+'...'+item.contract.substring(item.contract.length-4) : 'åˆçº¦æœªçŸ¥' }} <br>
                        é“¾: {{ item.chain_id || 'N/A' }} | DEX: {{ item.dex_id || 'N/A' }} <br>
                        æ¥æº: {{ item.source_channel || 'N/A' }} | æ—¶é—´: {{ formatTime(item.timestamp) }} <br>
                        <template v-if="item.links && item.links.length">
                            é“¾æ¥: <a v-for="(link, idx) in item.links" :key="idx" :href="link" target="_blank" rel="noopener noreferrer">{{ getLinkDomain(link) }} </a>
                        </template>
                    </div>
                </li>
                <li v-if="error.feed" style="color: red;">æ— æ³•åŠ è½½æ–°å¸æµ: {{ error.feed }}</li>
            </ul>
        </section>
    </main>
    {% endraw %} <!-- ç»“æŸ Jinja2 çš„ raw å— -->
</div>

<script>
    const { createApp, ref, onMounted, reactive } = Vue

    createApp({
        setup() {
            const apiBaseUrl = ref('{{ api_base_url }}'); // ä» Flask ä¼ é€’, é€šå¸¸ä¸ºç©ºå­—ç¬¦ä¸²æˆ–åº”ç”¨å­è·¯å¾„

            const feed = ref([]);
            const signals = ref([]);
            const logs = ref([]);
            
            const error = reactive({
                feed: null,
                signals: null,
                logs: null
            });
            const loading = reactive({
                feed: true,
                signals: true,
                logs: true
            });

            const fetchData = async () => {
                const endpoints = {
                    feed: `${apiBaseUrl.value}/api/v2/feed`,
                    signals: `${apiBaseUrl.value}/api/v2/signals`,
                    logs: `${apiBaseUrl.value}/api/v2/logs`
                };

                const fetchEndpoint = async (key) => {
                    loading[key] = true;
                    error[key] = null;
                    try {
                        const response = await fetch(endpoints[key]);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        if (key === 'feed') feed.value = data;
                        if (key === 'signals') signals.value = data;
                        if (key === 'logs') logs.value = data;
                    } catch (e) {
                        console.error(`Failed to fetch ${key}`, e);
                        error[key] = e.message;
                    } finally {
                        loading[key] = false;
                    }
                };

                await Promise.all([
                    fetchEndpoint('feed'),
                    fetchEndpoint('signals'),
                    fetchEndpoint('logs')
                ]);
            };

            const formatTime = (timestamp) => {
                if (!timestamp) return 'N/A';
                // å°è¯•å¤„ç†å¤šç§å¯èƒ½çš„ UTC æ ¼å¼
                let dateStr = timestamp.replace(' ', 'T');
                if (!dateStr.endsWith('Z') && !dateStr.includes('+') && !dateStr.includes('-')) {
                    // å¦‚æœæ—¶é—´æˆ³ä¸å«æ—¶åŒºä¿¡æ¯ï¼Œåˆ™å‡å®šä¸ºUTCå¹¶æ·»åŠ 'Z'
                    dateStr += 'Z';
                }
                try {
                    return new Date(dateStr).toLocaleString();
                } catch (e) {
                    console.warn("Could not parse date:", timestamp, e);
                    return timestamp; // è§£æå¤±è´¥åˆ™è¿”å›åŸå§‹å€¼
                }
            };

            const getLinkDomain = (urlString) => {
                try {
                    const url = new URL(urlString);
                    let domain = url.hostname.replace('www.', '');
                    if (domain === 't.me') return 'Telegram';
                    if (domain === 'twitter.com' || domain === 'x.com') return 'X/Twitter';
                    if (domain === 'dexscreener.com') return 'DexScreener';
                    if (domain === 'poocoin.app') return 'PooCoin';
                    return domain.split('.')[0]; // ç®€åŒ–åŸŸåæ˜¾ç¤º
                } catch (e) {
                    return 'Link';
                }
            };

            onMounted(() => {
                fetchData();
                setInterval(fetchData, 20000); // æ¯ 20 ç§’åˆ·æ–°ä¸€æ¬¡
            });

            return {
                feed,
                signals,
                logs,
                error,
                loading,
                formatTime,
                getLinkDomain
            };
        }
    }).mount('#app')
</script>
</body>
</html>
